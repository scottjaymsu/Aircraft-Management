services:
  test-db:
    image: test-db:latest
    build: 
      context: ./test_db
      dockerfile: Dockerfile
    container_name: mysql_container
    ports:
      - "3306:3306"
    networks:
      - FAA-messages
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "--host=localhost"]
      interval: 5s
      timeout: 50s
      retries: 10
      start_period: 10s
  
  test-message-consumer:
    image: test-message-consumer:latest
    build:
      context: ./test_message_consumer
      dockerfile: Dockerfile
    ports:
      - "8080:5000"
    networks:
      - FAA-messages
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/messages/consume"]
      interval: 1s
      timeout: 10s
      retries: 10
      start_period: 1s

  flight-plan-tracking:
    image: flight-plan-tracking:latest
    build:
      context: ../flight_plan_tracking
      dockerfile: Dockerfile
    env_file:
      - .env
    depends_on:
      test-db:
        condition: service_healthy
      test-message-consumer:
        condition: service_healthy
    networks:
      - FAA-messages

  tester:
    image: tester:latest
    build:
      context: ./tester
      dockerfile: Dockerfile
    env_file:
      - .env
    depends_on:
      flight-plan-tracking:
        condition: service_started
    networks:
      - FAA-messages

networks:
  FAA-messages:
    driver: bridge